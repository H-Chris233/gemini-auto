# Gemini Auto Web + K8s 部署计划

**创建时间**: 2026-01-15 06:26:19

## 需求概述

将 `gemini-auto.py` CLI 工具改造为：
- **Web UI 操作界面**
- **单 Docker 镜像**（Nginx + FastAPI）
- **单端口暴露**（默认 8080）
- **纯 Headless 模式**（无 noVNC）
- **K8s 部署配置**
- **开箱即用**

## 技术方案

### 架构设计
```
用户访问: http://domain:8080/
     │
     ▼
┌─────────────────────────────────────┐
│  Nginx (主进程，容器内端口: 8080)    │
│  ├── /api/*  ──▶ FastAPI (Uvicorn) │
│  └── /*      ──▶ Vue 前端静态文件   │
└─────────────────────────────────────┘
```

### 技术栈
- **后端框架**: FastAPI (异步、高性能)
- **前端框架**: Vue3 + Vite (构建产物嵌入镜像)
- **浏览器控制**: undetected-chromedriver (Headless)
- **Web 服务器**: Nginx (反向代理 + 静态资源)
- **进程管理**: supervisor (容器内多进程管理)
- **运行环境**: Python 3.11 + Chrome/Chromium

## 目录结构

```
gemini-auto/
├── app/
│   ├── __init__.py
│   ├── main.py                 # FastAPI 主入口
│   ├── config.py               # 配置管理（环境变量）
│   ├── schemas/                # Pydantic 数据模型
│   │   ├── __init__.py
│   │   ├── task.py
│   │   └── account.py
│   ├── api/                    # API 路由
│   │   ├── __init__.py
│   │   ├── health.py           # 健康检查
│   │   ├── tasks.py            # 任务管理
│   │   ├── accounts.py         # 账号管理
│   │   └── logs.py             # 日志流 (SSE)
│   ├── worker/                 # 注册任务 worker
│   │   ├── __init__.py
│   │   ├── browser.py          # 浏览器管理
│   │   └── register.py         # 注册逻辑
│   └── utils/                  # 工具函数
│       ├── __init__.py
│       └── logger.py
├── frontend/                   # Vue3 前端源码
│   ├── src/
│   │   ├── App.vue
│   │   ├── main.js
│   │   ├── api/                # API 调用封装
│   │   │   └── index.js
│   │   ├── components/         # 通用组件
│   │   │   ├── StatusCard.vue
│   │   │   └── LogViewer.vue
│   │   └── views/              # 页面视图
│   │       ├── Dashboard.vue
│   │       └── Accounts.vue
│   ├── package.json
│   └── vite.config.js
├── nginx/
│   ├── default.conf            # Nginx 配置
│   └── nginx.conf
├── scripts/
│   └── entrypoint.sh           # 容器启动脚本
├── requirements.txt            # Python 依赖
├── Dockerfile                  # 容器构建文件
└── k8s/
    └── deployment.yaml         # K8s 部署配置

7 directories, 27 files
```

## 执行步骤

### 阶段 1：后端基础设施 (预计代码量: ~200 行)

#### 步骤 1.1: 创建项目结构和基础配置
- **预期结果**: 完整的目录结构和 `requirements.txt`
- **新建文件**:
  - `app/__init__.py`
  - `app/config.py` - 从环境变量加载配置
  - `requirements.txt` - 依赖清单

#### 步骤 1.2: 定义数据模型
- **预期结果**: Pydantic schemas 用于 API 数据验证
- **新建文件**:
  - `app/schemas/__init__.py`
  - `app/schemas/task.py` - TaskStatus, TaskCreate, TaskResult
  - `app/schemas/account.py` - Account, AccountCreate

#### 步骤 1.3: 实现 API 路由
- **预期结果**: 基础 API 端点
- **新建文件**:
  - `app/api/__init__.py`
  - `app/api/health.py` - GET /health 健康检查
  - `app/api/tasks.py` - POST /tasks 启动任务, GET /tasks/{id} 查询状态
  - `app/api/accounts.py` - GET /accounts 账号列表, DELETE /accounts/{id}

### 阶段 2：浏览器注册核心 (预计代码量: ~300 行)

#### 步骤 2.1: 浏览器管理模块
- **预期结果**: Chrome 浏览器初始化和清理
- **新建文件**:
  - `app/worker/__init__.py`
  - `app/worker/browser.py` - BrowserManager 类

#### 步骤 2.2: 注册逻辑重构
- **预期结果**: 从原 `gemini-auto.py` 迁移注册逻辑
- **新建文件**:
  - `app/worker/register.py` - register_single_account 函数

#### 步骤 2.3: 任务调度器
- **预期结果**: 后台线程任务管理
- **修改文件**: `app/api/tasks.py` - 添加后台任务执行

### 阶段 3：前端界面 (预计代码量: ~400 行 Vue)

#### 步骤 3.1: Vue3 项目初始化
- **预期结果**: 完整的 Vue3 项目结构
- **新建文件**:
  - `frontend/src/App.vue`
  - `frontend/src/main.js`
  - `frontend/package.json`
  - `frontend/vite.config.js`

#### 步骤 3.2: 通用组件
- **预期结果**: 可复用的 UI 组件
- **新建文件**:
  - `frontend/src/components/StatusCard.vue` - 状态卡片
  - `frontend/src/components/LogViewer.vue` - 日志滚动组件

#### 步骤 3.3: 页面视图
- **预期结果**: Dashboard 和 Accounts 页面
- **新建文件**:
  - `frontend/src/views/Dashboard.vue` - 任务控制台
  - `frontend/src/views/Accounts.vue` - 账号管理

#### 步骤 3.4: API 封装
- **预期结果**: 前端 API 调用封装
- **新建文件**:
  - `frontend/src/api/index.js`

### 阶段 4：容器化和部署 (预计代码量: ~100 行)

#### 步骤 4.1: Nginx 配置
- **预期结果**: 反向代理配置
- **新建文件**:
  - `nginx/default.conf` - 主配置
  - `nginx/nginx.conf` - 基础配置

#### 步骤 4.2: Docker 构建
- **预期结果**: 完整的 Dockerfile
- **新建文件**:
  - `Dockerfile` - 多阶段构建
  - `scripts/entrypoint.sh` - 启动脚本

#### 步骤 4.3: K8s 部署配置
- **预期结果**: K8s Deployment 和 Service
- **新建文件**:
  - `k8s/deployment.yaml`

### 阶段 5：测试和优化 (预计代码量: ~50 行)

#### 步骤 5.1: 本地测试验证
- **预期结果**: 开发环境运行验证

#### 步骤 5.2: Docker 构建测试
- **预期结果**: 镜像构建成功

#### 步骤 5.3: K8s 部署测试
- **预期结果**: K8s 部署成功

## 环境变量配置

| 变量名 | 必填 | 默认值 | 说明 |
|--------|------|--------|------|
| `API_HOST` | 是 | - | 服务器 API 地址 |
| `ADMIN_KEY` | 是 | - | 管理员密钥 |
| `MAIL_API` | 否 | `https://mail.chatgpt.org.uk` | 临时邮箱 API |
| `MAIL_KEY` | 否 | `gpt-test` | 邮箱 API 密钥 |
| `HEADLESS_MODE` | 否 | `true` | 浏览器无头模式 |
| `CONCURRENT_TASKS` | 否 | `1` | 并发任务数 |
| `LISTEN_PORT` | 否 | `8080` | Web 服务端口 |
| `LOG_LEVEL` | 否 | `INFO` | 日志级别 |

## API 接口设计

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /health | 健康检查 |
| POST | /api/tasks | 启动注册任务 |
| GET | /api/tasks/{id} | 查询任务状态 |
| DELETE | /api/tasks/{id} | 停止任务 |
| GET | /api/tasks/{id}/logs | SSE 日志流 |
| GET | /api/accounts | 账号列表 |
| POST | /api/accounts/upload | 上传账号配置 |
| GET | /api/config | 获取当前配置 |

## 注意事项

1. **设备性能**: 保持轻量，不引入 Redis/Celery 等重量级依赖
2. **单端口**: 所有流量通过 Nginx 80/8080 端口
3. **纯 Headless**: 不包含 noVNC，节省资源
4. **数据持久化**: K8s 中使用 PVC 存储账号文件

## 预计总代码量

- Python 后端: ~500 行
- Vue 前端: ~400 行
- 配置/脚本: ~150 行
- **总计**: ~1050 行

---
*计划制定完成，等待用户批准后开始执行*
